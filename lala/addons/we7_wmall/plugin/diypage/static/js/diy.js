define(["jquery.ui"],function(a){var b={sysinfo:null,id:0,type:1,navs:{},initPart:[],data:{},selected:"page",childid:null,keyworderr:!1};return jQuery.base64=function(a){function b(a,b){var c=h.indexOf(a.charAt(b));if(-1===c)throw"Cannot decode base64";return c}function c(a,b){for(;a.length>0;){var c=a[0];if(c<128)a.shift(),b.push(String.fromCharCode(c));else if(192==(128&c)){if(a.length<2)break;c=a.shift();var d=a.shift();b.push(String.fromCharCode(((31&c)<<6)+(63&d)))}else{if(a.length<3)break;c=a.shift();var d=a.shift(),e=a.shift();b.push(String.fromCharCode(((15&c)<<12)+((63&d)<<6)+(63&e)))}}}function d(a){var d,e,f=0,h=a.length,i=[],j=[];if(a=String(a),0===h)return a;if(h%4!=0)throw"Cannot decode base64";for(a.charAt(h-1)===g&&(f=1,a.charAt(h-2)===g&&(f=2),h-=4),d=0;d<h;d+=4){b(a,d),b(a,d+1),b(a,d+2),b(a,d+3);e=b(a,d)<<18|b(a,d+1)<<12|b(a,d+2)<<6|b(a,d+3),j.push(e>>16),j.push(e>>8&255),j.push(255&e),c(j,i)}switch(f){case 1:e=b(a,d)<<18|b(a,d+1)<<12|b(a,d+2)<<6,j.push(e>>16),j.push(e>>8&255);break;case 2:e=b(a,d)<<18|b(a,d+1)<<12,j.push(e>>16)}if(c(j,i),j.length>0)throw"Cannot decode base64";return i.join("")}function e(a,b){a<128?b.push(a):a<2048?(b.push(192+(a>>6&31)),b.push(128+(63&a))):(b.push(224+(a>>12&15)),b.push(128+(a>>6&63)),b.push(128+(63&a)))}function f(a){if(1!==arguments.length)throw"SyntaxError: exactly one argument required";if(a=String(a),0===a.length)return a;var b,c,d=[],f=[],i=a.length;for(b=0;b<i;){for(e(a.charCodeAt(b),d);d.length>=3;){var j=d.shift(),k=d.shift();c=j<<16|k<<8|d.shift(),f.push(h.charAt(c>>18)),f.push(h.charAt(c>>12&63)),f.push(h.charAt(c>>6&63)),f.push(h.charAt(63&c))}b++}switch(d.length){case 1:c=d.shift()<<16,f.push(h.charAt(c>>18)+h.charAt(c>>12&63)+g+g);break;case 2:var j=d.shift(),k=d.shift();c=j<<16|k<<8,f.push(h.charAt(c>>18)+h.charAt(c>>12&63)+h.charAt(c>>6&63)+g)}return f.join("")}var g="=",h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";return{decode:d,encode:f,VERSION:"1.1"}}(jQuery),b.init=function(a){window.tmodtpl=a.tmodtpl,b.attachurl=a.attachurl,b.type=a.type,b.data=a.data,b.id=a.id,b.mallset=a.mallset,b.diymenu=a.diymenu,b.data&&(b.type=b.data.page.type,b.page=b.data.page,b.items=b.data.items),b.initTpl(),b.initPage(),b.initItems(),b.initParts(),b.initSortable(),b.initGotop(),b.initSave(),$("#page").unbind("click").click(function(){"page"!=b.selected&&(b.selected="page",b.initPage())})},b.initParts=function(){b.getParts();var a={0:["waimai_goods","notice","waimai_stores","img_card","banner","picture","picturew","navs","graphic","richtext","line","blank"]},c=a[0];$.each(c,function(a,c){var d=b.parts[c];d&&(d.id=c,b.initPart.push(d))});var d=tmodtpl("tpl-parts",b);$("#parts").html(d).show(),$("#parts nav").unbind("click").click(function(){var a=$(this).data("id");if("page"===a)return void $("#page").trigger("click");if($.inArray(a,c)<0)return void Notify.error("此页面组建不存在！");var d=$.extend(!0,{},b.parts[a]);if(delete d.name,!d)return void Notify.error("未找到此元素！");var e=$("#tpl-show-"+a).length,f=$("#tpl-editor-"+a).length;if(0==e||0==f)return void Notify.error("添加失败！模板错误，请刷新页面重试");var g=b.getId("M",0);if(d.data){var h=$.extend(!0,{},d.data),i={},j=0;$.each(h,function(a,c){var d=b.getId("C",j);i[d]=c,delete d,j++}),d.data=i}if(d.max&&d.max>0){var k=b.getItemNum(a);if(k>0&&k>=d.max)return void Notify.error("此元素最多允许添加 "+d.max+" 个")}var l=!0;if(b.selected&&"page"!=b.selected){var m=b.items[b.selected],n=[];n.length>0&&-1!=$.inArray(m.id,n)&&(l=!1)}if(d.istop){var o={};o[g]=d,$.each(b.items,function(a,b){o[a]=b}),b.items=o}else if(b.selected&&"page"!=b.selected&&l){var o={};$.each(b.items,function(a,c){o[a]=c,a==b.selected&&(o[g]=d)}),b.items=o}else b.items[g]=d;b.initItems(),$(".drag[data-itemid='"+g+"']").trigger("mousedown").trigger("click"),b.selected=g})},b.getId=function(a,b){return a+(+new Date+b)},b.getParts=function(){b.parts={img_card:{name:"图片标题",params:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/img-card-1.jpg"},style:{paddingtop:"0",paddingleft:"0"}},banner:{name:"单图组",params:{},style:{paddingtop:"0",paddingleft:"10"},data:{C0123456789101:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/banner-1.jpg?t=1",linkurl:""},C0123456789102:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/banner-2.jpg",linkurl:""}}},picture:{name:"图片轮播",params:{},style:{paddingtop:"0",paddingleft:"10",dotalign:"center",leftright:"5",bottom:"5",dotbackground:"#ff2d4b"},data:{C0123456789101:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/picture-1.jpg",linkurl:""},C0123456789102:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/picture-2.jpg",linkurl:""}}},richtext:{name:"富文本",params:{content:""},style:{background:"#ffffff",paddingleft:"0",paddingtop:"0"}},title:{name:"标题栏",params:{title:"",icon:""},style:{background:"#ffffff",color:"#666666",textalign:"left",fontsize:"12",paddingtop:"5",paddingleft:"5"}},line:{name:"辅助线",params:{},style:{height:"2",background:"#ffffff",border:"#000000",padding:"10",linestyle:"solid"}},blank:{name:"辅助空白",params:{},style:{height:"20",background:"#ffffff"}},picturew:{name:"图片橱窗",params:{row:"1",showtype:0},style:{paddingtop:"10",paddingleft:"10",showdot:0,pagenum:"2",dotbackground:"#ff2d4b"},data:{C0123456789101:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/cube-1.jpg?t=1",linkurl:""},C0123456789102:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/cube-2.jpg",linkurl:""},C0123456789103:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/cube-1.jpg",linkurl:""},C0123456789104:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/cube-2.jpg",linkurl:""}}},navs:{name:"导航栏",params:{showtype:0,showdot:0,rownum:"4",pagenum:"8"},style:{paddingtop:"10",paddingleft:"10",navstyle:"",background:"#ffffff",dotbackground:"#ff2d4b"},data:{C0123456789101:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-1.png",linkurl:"",text:"导航文字1",color:"#666666"},C0123456789102:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-2.png",linkurl:"",text:"导航文字2",color:"#666666"},C0123456789103:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-3.png",linkurl:"",text:"导航文字3",color:"#666666"},C0123456789104:{imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-4.png",linkurl:"",text:"导航文字4",color:"#666666"}}},graphic:{name:"导航栏1",params:{},style:{paddingtop:"5",paddingleft:"5",cardbackground:"#efeff4",titlecolor:"#333333",subheadcolor:"#606060",background:"#ffffff"},data:{C0123456789101:{title:"来包香烟",subhead:"25分钟送达",imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-5.png",linkurl:""},C0123456789102:{title:"生活用品",subhead:"25分钟送达",imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-6.png",linkurl:""},C0123456789103:{title:"常用药品",subhead:"30分钟送达",imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-7.png",linkurl:""},C0123456789104:{title:"咖啡奶茶",subhead:"25分钟送达",imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/navs-8.png",linkurl:""}}},notice:{name:"公告",params:{noticedata:0,noticenum:5,speed:2,imgurl:"../addons/we7_wmall/plugin/diypage/static/img/default/hotdot.png"},style:{paddingtop:"10",paddingleft:"10",textcolor:"#666666",iconcolor:"#fd5454",background:"#ffffff"},data:{C0123456789101:{linkurl:"",title:"这里是第一条自定义公告的标题"},C0123456789102:{linkurl:"",title:"这里是第二条自定义公告的标题"},C0123456789103:{linkurl:"",title:"这里是第三条自定义公告的标题"}}},waimai_goods:{name:"商品组",params:{goodstype:"0",showtitle:"1",showprice:"1",showoldprice:"1",showtag:"0",goodsdata:"0",goodssort:"0",goodsnum:"6",showicon:"1",iconposition:"left top",buybtntext:"立即抢购",goodsiconsrc:""},style:{background:"#fafafa",paddingtop:"10",paddingleft:"10",liststyle:"1",goodsicon:"recommand",titlecolor:"#333",pricecolor:"#fb4e44",oldpricecolor:"#999",buybtncolor:"#fb4e44",iconpaddingtop:"0",iconpaddingleft:"0",iconzoom:"100",tagbackground:"#fe5455",salescolor:"#777777"},data:{C0123456789101:{sid:"0",goods_id:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-1.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"},C0123456789102:{sid:"0",goods_id:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-2.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"},C0123456789103:{sid:"0",goods_id:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-3.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"},C0123456789104:{sid:"0",goods_id:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-4.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"}}},waimai_stores:{name:"商户组",params:{showdiscount:"1",showhotgoods:"1",storedata:"0",storenum:"6"},style:{background:"#fafafa",paddingtop:"10",paddingleft:"10",titlecolor:"#333",scorecolor:"#ff2d4b",deliverytitlebgcolor:"#ff2d4b",deliverytitlecolor:"#fff"},data:{C0123456789101:{store_id:0,logo:"../addons/we7_wmall/plugin/diypage/static/img/default/store-1.jpg",title:"这里是门店名称",score:"5",sailed:"888",send_price:"15",delivery_price:"5",delivery_title:"平台专送",delivery_time:30,activity:{items:{C0123456789101:{type:"discount",title:"满35减12;满60减20"},C0123456789102:{type:"couponCollect",title:"可领2元代金券"}},num:2},hot_goods:{C0123456789101:{sid:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-1.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"},C0123456789102:{sid:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-2.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"},C0123456789103:{sid:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-3.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"}}},C0123456789102:{store_id:0,logo:"../addons/we7_wmall/plugin/diypage/static/img/default/store-2.jpg",title:"这里是门店名称",score:"5",sailed:"888",send_price:"15",delivery_price:"5",delivery_title:"平台专送",delivery_time:45},C0123456789103:{store_id:0,logo:"../addons/we7_wmall/plugin/diypage/static/img/default/store-3.jpg",title:"这里是门店名称",score:"5",sailed:"888",send_price:"15",delivery_price:"5",delivery_title:"平台专送",delivery_time:55,hot_goods:{C0123456789101:{sid:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-4.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"},C0123456789102:{sid:"0",thumb:"../addons/we7_wmall/plugin/diypage/static/img/default/goods-5.jpg",price:"20.00",old_price:"10.00",title:"这里是商品标题",store_title:"这里是门店名称",discount:"5",sailed:"20",comment_good_percent:"88%"}}}}}}},b.initItems=function(a){var c=$("#app-preview");if(!b.items)return void(b.items={});c.empty(),$.each(b.items,function(a,b){if(void 0!==b.id){var d=$.extend(!0,{},b);d.itemid=a;var e=tmodtpl("tpl-show-"+b.id,d);c.append(e)}});var d=$("#tpl-editor-del").html();$("#app-preview .drag").append(d),$("#app-preview .drag .btn-edit-del .btn-del").unbind("click").click(function(a){a.stopPropagation();var c=$(this).closest(".drag"),d=c.data("itemid");if($(this).closest(".drag").hasClass("nodelete"))return void Notify.error("此组建禁止删除");Notify.confirm("确定删除吗",function(){var a=b.getNear(d);delete b.items[d],b.initItems(),a?$(document).find(".drag[data-itemid='"+a+"']").trigger("mousedown"):$("#page").trigger("click")})}),a&&b.selectedItem(a)},b.selectedItem=function(a){a&&(b.selected=a,"page"==a?$("#page").trigger("click"):$(".drag[data-itemid='"+a+"']").addClass("selected"))},b.initPage=function(a){void 0===a&&(a=!0),b.page||(b.page={type:b.type,title:"请输入页面标题",name:"未命名页面",desc:"",thumb:"",keyword:"",background:"#efeff4",diymenu:"-1",danmu:0,diygotop:"0",followbar:"0"}),$("#page").text(b.page.title),$("#app-preview").css({"background-color":b.page.background}),$("#app-preview").find(".drag").removeClass("selected"),a&&b.initEditor()},b.initSortable=function(){$("#app-preview").sortable({opacity:.8,placeholder:"highlight",items:".drag:not(.fixed)",revert:100,scroll:!1,start:function(a,b){var c=b.item.height();$(".highlight").css({height:c+22+"px","margin-bottom":"10px"}),$(".highlight").html('<div><i class="icon icon-plus"></i> 放置此处</div>'),$(".highlight div").css({"line-height":c+16+"px","font-size":"16px",color:"#999","text-align":"center",border:"2px dashed #eee"})},stop:function(a,c){b.initEditor()},update:function(a,c){b.sortItems()}}),$("#app-preview").disableSelection(),$(document).on("mousedown","#app-preview .drag",function(){$(this).hasClass("selected")||($("#app-preview").find(".drag").removeClass("selected"),$(this).addClass("selected"),b.selected=$(this).data("itemid"),b.initEditor())})},b.sortItems=function(){var a={};$("#app-preview .drag").each(function(){var c=$(this).data("itemid");a[c]=b.items[c]}),b.items=a},b.initEditor=function(a){void 0===a&&(a=!0);var c=b.selected,d=-50;if("page"!=b.selected){var e=$(".selected").position().top;d=e||0}if(a&&($("#app-editor").unbind("animate").animate({"margin-top":d+100+"px"}),setTimeout(function(){$("body").unbind("animate").animate({scrollTop:d+100+"px"},1e3)},1e3)),b.selected){if("page"==b.selected){var f=tmodtpl("tpl-editor-page",b);$("#app-editor .inner").html(f)}else{var g=$.extend(!0,{},b.items[b.selected]);g.itemid=b.selected;var f=tmodtpl("tpl-editor-"+g.id,g);$("#app-editor .inner").html(f)}$("#app-editor").attr("data-editid",b.selected).show()}if($("#app-editor .js-selectGoods").length>0&&($(document).off("click",".js-selectGoods"),$(document).on("click",".js-selectGoods",function(){b.childid=$(this).closest(".item").data("id");var a=$(this).data("callback");irequire(["web/tiny"],function(b){b.selectgoods(a,{mutil:0})})})),$("#app-editor .js-selectStore").length>0&&($(document).off("click",".js-selectStore"),$(document).on("click",".js-selectStore",function(){b.childid=$(this).closest(".item").data("id");var a=$(this).data("callback");irequire(["web/tiny"],function(b){b.selectStore(a,{mutil:0})})})),$("#app-editor .slider").length>0&&$("#app-editor .slider").each(function(){var a=$(this).data("decimal"),b=($(this).data("multiply"),$(this).data("value"));a&&(b*=a),$(this).slider({slide:function(b,c){var d=c.value;a&&(d/=a),$(this).siblings(".input").val(d).trigger("propertychange"),$(this).siblings(".count").find("span").text(d)},value:b,min:$(this).data("min"),max:$(this).data("max")})}),$("#app-editor .form-items").length>0&&(b.initSortableChild(),$("#addChild").unbind("click").click(function(){var a=b.selected,c=b.items[a].id,d=b.parts[c].data,e=$(this).closest(".form-items").data("max");if(e&&b.length(b.items[a].data)>=e)return void Notify.error("最大添加 "+e+" 个！");var f={},g=0;if($.each(d,function(a,b){0==g&&(f=b,g++)}),f){var h=b.getId("M",0);void 0===b.items[a].data&&(b.items[a].data={}),f=$.extend(!0,{},f),b.items[a].data[h]=f}b.initItems(a),b.initEditor(!1)}),$("#app-editor .form-items .item .btn-del").unbind("click").click(function(){var a=$(this).closest(".item").data("id"),c=b.selected,d=$(this).closest(".form-items").data("min");if(d&&b.length(b.items[c].data)<=d)return void Notify.error("至少保留 "+d+" 个！");Notify.confirm("确定删除吗",function(){delete b.items[c].data[a],b.initItems(c),b.initEditor(!1)})})),$("#app-editor .form-richtext").length>0){var h={autoClearinitialContent:!1,toolbars:[["fullscreen","source","preview","|","bold","italic","underline","strikethrough","forecolor","backcolor","|","justifyleft","justifycenter","justifyright","|","insertorderedlist","insertunorderedlist","blockquote","emotion","removeformat","|","rowspacingtop","rowspacingbottom","lineheight","indent","paragraph","fontsize","|","inserttable","deletetable","insertparagraphbeforetable","insertrow","deleterow","insertcol","deletecol","mergecells","mergeright","mergedown","splittocells","splittorows","splittocols","|","anchor","map","print","drafts","|","link"]],elementPathEnabled:!1,initialFrameHeight:300,focus:!1,maximumWords:9999999999999},j={type:"image",direct:!1,multiple:!0,tabs:{upload:"active",browser:"",crawler:""},path:"",dest_dir:"",global:!1,thumb:!1,width:0};UE.registerUI("myinsertimage",function(a,b){a.registerCommand(b,{execCommand:function(){require(["fileUploader"],function(b){b.show(function(b){if(0!=b.length)if(1==b.length)a.execCommand("insertimage",{src:b[0].url,_src:b[0].url,width:"100%",alt:b[0].filename});else{var c=[];for(i in b)c.push({src:b[i].url,_src:b[i].url,width:"100%",alt:b[i].filename});a.execCommand("insertimage",c)}},j)})}});var c=new UE.ui.Button({name:"插入图片",title:"插入图片",cssRules:"background-position: -726px -77px",onclick:function(){a.execCommand(b)}});return a.addListener("selectionchange",function(){var d=a.queryCommandState(b);-1==d?(c.setDisabled(!0),c.setChecked(!1)):(c.setDisabled(!1),c.setChecked(d))}),c},48),UE.registerUI("myinsertvideo",function(a,b){a.registerCommand(b,{execCommand:function(){require(["fileUploader"],function(b){b.show(function(b){if(b){var c=b.isRemote?"iframe":"video";a.execCommand("insertvideo",{url:b.url,width:300,height:200},c)}},{fileSizeLimit:512e4,type:"video",allowUploadVideo:!0})})}});var c=new UE.ui.Button({name:"插入视频",title:"插入视频",cssRules:"background-position: -320px -20px",onclick:function(){a.execCommand(b)}});return a.addListener("selectionchange",function(){var d=a.queryCommandState(b);-1==d?(c.setDisabled(!0),c.setChecked(!1)):(c.setDisabled(!1),c.setChecked(d))}),c},20),UE.registerUI("mylink",function(a,b){var c=new UE.ui.Button({name:"selectUrl",title:"系统链接",cssRules:"background-position: -622px 80px;",onclick:function(){$("#"+this.id).attr({"data-toggle":"selectUrl","data-callback":"selectUrlCallback"})}});return a.addListener("selectionchange",function(){var d=a.queryCommandState(b);-1==d?(c.setDisabled(!0),c.setChecked(!1)):(c.setDisabled(!1),c.setChecked(d))}),c}),"undefined"!=typeof UE&&UE.delEditor("rich");var k=UE.getEditor("rich",h);k.ready(function(){var a=b.items[c],d=a.params.content;d=$.base64.decode(d),k.setContent(d),k.addListener("contentChange",function(){var a=k.getContent();a=$.base64.encode(a),$("#richtext").html(a).trigger("change")})})}$("#app-editor").find(".diy-bind").bind("input propertychange change",function(){var a=$(this),d=a.data("bind"),e=a.data("bind-child"),f=a.data("bind-parent"),g=a.data("bind-init"),h="",i=this.tagName;if(c||b.selectedItem("page"),"INPUT"==i){if("checkbox"==a.attr("type"))h=[],a.closest(".form-group").find("input[type=checkbox]").each(function(){var a=this.checked,b=$(this).val();a&&h.push(b)});else{var j=a.data("placeholder");h=a.val(),h=""==h?j:h}}else"SELECT"==i?h=a.find("option:selected").val():"TEXTAREA"==i&&(h=a.val());h=$.trim(h),"page"==c?(e?(b.page[e]||(b.page[e]={}),b.page[e][d]=h):b.page[d]=h,b.initPage(!1),"keyword"==d&&$.post(biz.url("diypage/page/keyword"),{id:b.id,keyword:h},function(c){0==c.status?(a.closest(".form-group").addClass("has-error"),b.keyworderr=!0):(a.closest(".form-group").removeClass("has-error"),b.keyworderr=!1)},"json")):(e?f?b.items[c][f][e][d]=h:b.items[c][e][d]=h:b.items[c][d]=h,b.initItems(c)),g&&b.initEditor(!1)})},b.initSortableChild=function(){$("#app-editor .inner").sortable({opacity:.8,placeholder:"highlight",items:".item",revert:100,scroll:!1,cancel:".goods-selector,input,select,.btn,btn-del",start:function(a,b){var c=b.item.height();$(".highlight").css({height:c+22+"px"}),$(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>'),$(".highlight div").css({"line-height":c+16+"px"})},update:function(a,c){b.sortChildItems()}})},b.initTpl=function(){tmodtpl.helper("tomedia",function(a){return 0==a.indexOf("images/")?b.attachurl+a:"string"!=typeof a?"":0==a.indexOf("http://")||0==a.indexOf("https://")||0==a.indexOf("../addons/we7_wmall/")?a:0==a.indexOf("images/")||0==a.indexOf("audios/")?b.attachurl+a:void 0}),tmodtpl.helper("decode",function(a){return $.base64.decode(a)}),tmodtpl.helper("count",function(a){return b.length(a)}),tmodtpl.helper("toArray",function(a){var b=($.makeArray(a),[]);return $.each(a,function(a,c){b.push(c)}),b}),tmodtpl.helper("strexists",function(a,b){return!(!a||!b)&&-1!=a.indexOf(b)}),tmodtpl.helper("inArray",function(a,b){if(!a||!b)return!1;if("string"==typeof a){var c=a.split(",");if($.inArray(b,c)>-1)return!0}return!1}),tmodtpl.helper("define",function(a){})},b.initGotop=function(){$(window).bind("scroll resize",function(){$(window).scrollTop()>300?$("#gotop").show():$("#gotop").hide(),$("#gotop").unbind("click").click(function(){$("body").animate({scrollTop:"0px"},1e3)})})},b.getNear=function(a){var c=[],d=0,e=0,f=0;$.each(b.items,function(b,g){c[d]=b,b==a&&(e=d-1,f=d+1),d++});var g=c[e],h=c[f];return h||(g||!1)},b.getItemNum=function(a){if(!a||!b.items)return-1;var c=0;return $.each(b.items,function(b,d){d.id==a&&c++}),c},b.sortChildItems=function(){var a={},c=b.selected;$("#app-editor .form-items .item").each(function(){var d=$(this).data("id");a[d]=b.items[c].data[d]}),b.items[c].data=a,b.initItems(c)},b.length=function(a){if(void 0===a)return 0;var b=0;for(var c in a)b++;return b},b.callbackGoods=function(a){if(!a)return void Notify.error("回调数据错误，请重试！");var c=b.selected,d=b.childid;b.items[c].data[d]={sid:a.sid,goods_id:a.id,title:a.title,thumb:a.thumb,price:a.price,old_price:a.old_price,discount:a.discount,store_title:a.store_title,sailed:a.sailed,comment_good_percent:a.comment_good_percent},b.initItems(c),b.initEditor(!1),b.childid=null},b.callbackStore=function(a){if(!a)return void Notify.error("回调数据错误，请重试！");var c=b.selected,d=b.childid;b.items[c].data[d]={store_id:a.id,logo:a.logo,title:a.title,score_cn:a.score_cn,sailed:a.sailed,send_price:a.send_price,delivery_price:a.delivery_price,delivery_title:a.delivery_title,delivery_time:a.delivery_time,activity:a.activity,hot_goods:a.hot_goods},console.dir(b.items[c].data[d]),b.initItems(c),b.initEditor(!1),b.childid=null},b.initSave=function(){$(".btn-save").unbind("click").click(function(){return $(this).data("status")?void Notify.error("正在保存，请稍候。。。"):(b.data={},b.data={page:b.page,items:b.items},b.page.title?($(".btn-save").data("status",1).text("保存中..."),void irequire(["tiny"],function(a){$.post(a.getUrl("diypage/diy/post"),{id:b.id,data:b.data},function(a){var a=a.message;if(0!=a.errno)return Notify.error(a.message),void $(".btn-save[data-type='save']").text("保存页面").data("status",0);Notify.success("保存成功！",a.url)},"json")})):(Notify.error("页面标题是必填项"),void $("#page").trigger("click")))})},b});